<app-employee-layout [sidenavLinks]="sidenavLinks">
    <app-toolbar [userFullName]="(currentUser$ | async)?.fullName">
        <span title><mat-icon>calendar_view_week</mat-icon> Submit Timesheet (Week View)</span>
    </app-toolbar>
    <div style="padding: 24px; display: flex; justify-content: center; align-items: flex-start; min-height: 80vh;">
        <mat-card style="width: 100%; max-width: 1200px;">
            <mat-card-content>
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                    <button mat-icon-button (click)="prevYear()"
                        aria-label="Previous Year"><mat-icon>fast_rewind</mat-icon></button>
                    <button mat-icon-button (click)="prevWeek()"
                        aria-label="Previous Week"><mat-icon>chevron_left</mat-icon></button>
                    <mat-label style="font-weight: 500;">{{ currentWeekStart | date: 'MMM d, y' }} - {{
                        addDays(currentWeekStart, 6) | date: 'MMM d, y' }}</mat-label>
                    <button mat-icon-button (click)="nextWeek()"
                        aria-label="Next Week"><mat-icon>chevron_right</mat-icon></button>
                    <button mat-icon-button (click)="nextYear()"
                        aria-label="Next Year"><mat-icon>fast_forward</mat-icon></button>
                    <mat-form-field appearance="fill" style="min-width: 180px; margin-left: 24px;">
                        <mat-label>Jump to Week</mat-label>
                        <mat-select (selectionChange)="selectWeek($event.value)" [value]="currentWeekStart">
                            <mat-option *ngFor="let w of weekOptions" [value]="w.start">{{ w.label }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <form [formGroup]="weekForm" (ngSubmit)="submitWeek()">
                    <table mat-table [dataSource]="tableRows" class="week-table">
                        <ng-container formArrayName="entries">
                            <ng-container matColumnDef="project">
                                <th mat-header-cell *matHeaderCellDef>Project</th>
                                <td mat-cell *matCellDef="let entry; let i = index" [formGroupName]="i">
                                    <mat-form-field appearance="fill" style="min-width: 180px;">
                                        <mat-label>Project</mat-label>
                                        <mat-select formControlName="projectCodeId" required>
                                            <mat-option value="" disabled selected>Select a project</mat-option>
                                            <mat-option *ngFor="let project of projects"
                                                [value]="project.projectCodeId">{{ project.projectName }}</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                    <button mat-icon-button color="warn" (click)="removeProjectRow(i)"
                                        *ngIf="entries.length > 1" type="button" aria-label="Delete Project Row">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </td>
                            </ng-container>
                            <ng-container *ngFor="let day of weekDays; let d = index" [matColumnDef]="day.label">
                                <th mat-header-cell *matHeaderCellDef>{{ day.label }}</th>
                                <td mat-cell *matCellDef="let entry; let i = index" [formGroupName]="i">
                                    <div formArrayName="days">
                                        <div [formGroupName]="d">
                                            <div class="custom-hours-input-wrapper">
                                                <mat-form-field appearance="fill"
                                                    style="width: 90px; min-width: 70px; margin: 0;">
                                                    <mat-label>Hours</mat-label>
                                                    <input matInput type="number" formControlName="hours" min="0"
                                                        max="24" placeholder="0" autocomplete="off"
                                                        class="custom-hours-input">
                                                </mat-form-field>
                                                <div class="custom-spinner">
                                                    <button type="button" (click)="incrementHour(entry, d)"
                                                        tabindex="-1"
                                                        aria-label="Increment hour"><mat-icon>keyboard_arrow_up</mat-icon></button>
                                                    <button type="button" (click)="decrementHour(entry, d)"
                                                        tabindex="-1"
                                                        aria-label="Decrement hour"><mat-icon>keyboard_arrow_down</mat-icon></button>
                                                </div>
                                            </div>
                                            <mat-form-field appearance="fill" style="width: 120px;">
                                                <mat-label>Description</mat-label>
                                                <input matInput formControlName="description">
                                            </mat-form-field>
                                            <div *ngIf="getDayError(entry.get('projectCodeId').value, day.date)"
                                                style="color: #d32f2f; font-size: 12px; margin-top: 2px;">
                                                <mat-icon
                                                    style="font-size: 14px; vertical-align: middle;">error_outline</mat-icon>
                                                {{ getDayError(entry.get('projectCodeId').value, day.date) }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </ng-container>
                            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                        </ng-container>
                    </table>
                    <button mat-stroked-button color="primary" type="button" (click)="addProjectRow()"
                        style="margin-top: 16px;">
                        <mat-icon>add</mat-icon> Add Project
                    </button>
                    <div style="margin-top: 24px; text-align: right;">
                        <button mat-raised-button color="primary" type="submit">Submit Week</button>
                    </div>
                </form>
            </mat-card-content>
        </mat-card>
    </div>
</app-employee-layout>