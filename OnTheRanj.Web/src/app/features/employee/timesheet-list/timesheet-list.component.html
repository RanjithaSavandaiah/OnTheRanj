<app-employee-layout [sidenavLinks]="sidenavLinks">
  <app-toolbar [userFullName]="(currentUser$ | async)?.fullName" (logout)="onLogout()">
    <span title><mat-icon>schedule</mat-icon> My Timesheets</span>
  </app-toolbar>
  <div style="padding: 24px;">
    <mat-card>
      <mat-card-header>
        <mat-card-title>My Timesheets</mat-card-title>
        <mat-card-subtitle>View and manage your timesheet entries</mat-card-subtitle>
      </mat-card-header>
      <div *ngIf="errorMessage$ | async as errorMessage"
        style="margin: 16px 0 0 0; color: #d32f2f; font-size: 15px; font-weight: 500; display: flex; align-items: center; gap: 8px;">
        <mat-icon style="font-size: 20px;">error_outline</mat-icon>
        <span>{{ errorMessage }}</span>
      </div>
      <mat-card-content style="padding-top: 16px;">
        <!-- New Timesheet Button -->
        <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
          <button mat-raised-button color="primary" (click)="createTimesheet()">New Timesheet</button>
        </div>
        <!-- Loading Spinner -->
        <div *ngIf="loading$ | async" class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
        <!-- Timesheet Table -->
        <div *ngIf="!(loading$ | async)">
          <table mat-table [dataSource]="(timesheets$ | async) || []" style="width: 100%;">
            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let timesheet">
                {{ timesheet.date | date: 'MMM d, y' }}
              </td>
            </ng-container>
            <!-- Project Code Column -->
            <ng-container matColumnDef="projectCode">
              <th mat-header-cell *matHeaderCellDef>Project</th>
              <td mat-cell *matCellDef="let timesheet">
                {{ timesheet.projectName }}
              </td>
            </ng-container>
            <!-- Hours Column -->
            <ng-container matColumnDef="hours">
              <th mat-header-cell *matHeaderCellDef>Hours</th>
              <td mat-cell *matCellDef="let timesheet">
                {{ timesheet.hoursWorked }}
              </td>
            </ng-container>
            <!-- Description Column -->
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef>Description</th>
              <td mat-cell *matCellDef="let timesheet">
                {{ timesheet.description }}
              </td>
            </ng-container>
            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let timesheet">
                <mat-chip
                  [color]="timesheet.status === 'Approved' ? 'primary' : timesheet.status === 'Submitted' ? 'accent' : timesheet.status === 'Rejected' ? 'warn' : 'default'">
                  {{ timesheet.status }}
                </mat-chip>
                <div *ngIf="timesheet.status === 'Rejected' && timesheet.managerComments" class="rejection-reason"
                  style="margin-top: 4px; color: #d32f2f; font-size: 13px;">
                  <mat-icon style="font-size: 16px; vertical-align: middle;">error_outline</mat-icon>
                  <span style="vertical-align: middle;">Reason: {{ timesheet.managerComments }}</span>
                </div>
              </td>
            </ng-container>
            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef style="text-align: center;">Actions</th>
              <td mat-cell *matCellDef="let timesheet" style="text-align: center;">
                <div style="display: flex; gap: 8px; justify-content: center;">
                  <button mat-icon-button color="primary" *ngIf="timesheet.status === 'Draft'"
                    (click)="editTimesheet(timesheet.id)" matTooltip="Edit Timesheet">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" *ngIf="timesheet.status === 'Draft'"
                    (click)="submitTimesheet(timesheet.id)" matTooltip="Submit Timesheet">
                    <mat-icon>send</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            <!-- No Data Row -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
                <div class="no-data-message">
                  <mat-icon>inbox</mat-icon>
                  <p>No timesheets found. Click "New Timesheet" to create one.</p>
                </div>
              </td>
            </tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</app-employee-layout>